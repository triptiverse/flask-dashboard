{% extends "base.html" %}

{% block title %}Vehicle Status{% endblock %}

{% block extra_css %}
<!-- Add Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .details-row {
        display: none;
        background-color: #f8f9fa;
        border-top: 2px solid #e9ecef;
    }
    
    .details-row.active {
        display: table-row;
    }
    
    .details-cell {
        padding: 20px !important;
    }
    
    .vehicle-row.selected {
        background-color: #e9ecef;
    }
    
    .map-container {
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .info-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-white py-3">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0">
                    <i class="fas fa-truck me-2 text-primary"></i>
                    Vehicle Status Overview
                </h5>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control form-control-sm" placeholder="Search vehicles...">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr class="bg-light">
                        <th class="px-4">Vehicle ID</th>
                        <th>Status</th>
                        <th>IGN</th>
                        <th>Power</th>
                        <th>Last Updated</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr class="vehicle-row" data-vehicle="{{ vehicle.vehicle_name }}">
                        <td class="px-4">{{ vehicle.vehicle_name }}</td>
                        <td>
                            <span class="badge bg-{{ vehicle.status_color }} bg-opacity-75">
                                {{ vehicle.status }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ vehicle.ign_color }} bg-opacity-75">
                                {{ vehicle.ign_status }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ vehicle.power_color }} bg-opacity-75">
                                {{ vehicle.power_status }}
                            </span>
                        </td>
                        <td>{{ vehicle.last_updated }}</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button onclick="toggleDetails('{{ vehicle.vehicle_name }}')" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button onclick="viewHistory('{{ vehicle.vehicle_name }}')" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-history"></i> History
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr class="details-row" id="details-{{ vehicle.vehicle_name }}">
                        <td colspan="6" class="details-cell">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="info-container" id="info-{{ vehicle.vehicle_name }}">
                                        <div class="text-center">
                                            <i class="fas fa-info-circle text-primary mb-2"></i>
                                            <p>Click Details to view information</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="map-container" id="map-{{ vehicle.vehicle_name }}"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentMap = null;
    let currentVehicleId = null;

    window.toggleDetails = function(vehicleId) {
        const detailsRow = document.getElementById(`details-${vehicleId}`);
        const vehicleRow = document.querySelector(`tr[data-vehicle="${vehicleId}"]`);
        
        // If already open, close it
        if (detailsRow.classList.contains('active')) {
            detailsRow.classList.remove('active');
            vehicleRow.classList.remove('selected');
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }
            return;
        }

        // Close any other open details
        document.querySelectorAll('.details-row.active').forEach(row => {
            row.classList.remove('active');
        });
        document.querySelectorAll('.vehicle-row.selected').forEach(row => {
            row.classList.remove('selected');
        });

        // Open this one
        detailsRow.classList.add('active');
        vehicleRow.classList.add('selected');

        // Show loading state
        document.getElementById(`info-${vehicleId}`).innerHTML = `
            <div class="text-center p-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading vehicle details...</p>
            </div>
        `;

        // Fetch vehicle details
        fetch(`/api/vehicle/${vehicleId}/location`)
            .then(response => response.json())
            .then(data => {
                // Update info
                document.getElementById(`info-${vehicleId}`).innerHTML = `
                    <h6 class="mb-3">Vehicle Information</h6>
                    <p><strong>ID:</strong> ${data.vehicle_id}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${data.status_color}">${data.status}</span></p>
                    <p><strong>IGN Status:</strong> ${data.ign_status}</p>
                    <p><strong>Power Status:</strong> ${data.power_status}</p>
                    <p><strong>Last Updated:</strong> ${data.last_updated}</p>
                    <p><strong>Location:</strong> ${data.Location}</p>
                `;

                // Initialize map
                if (currentMap) {
                    currentMap.remove();
                }
                
                const map = L.map(`map-${vehicleId}`).setView([data.latitude, data.longitude], 13);
                currentMap = map;
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                
                const marker = L.marker([data.latitude, data.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>${data.vehicle_id}</b><br>
                    Status: ${data.status}<br>
                    Last Updated: ${data.last_updated}
                `).openPopup();
                
                map.invalidateSize();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById(`info-${vehicleId}`).innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Error Loading Details</h6>
                        <p>Could not load vehicle details. Please try again.</p>
                    </div>
                `;
            });
    };

    window.viewHistory = function(vehicleId) {
        console.log('View history for:', vehicleId);
    };
});
</script>
{% endblock %}